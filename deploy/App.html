<!DOCTYPE html>
<html>
<head>
    <title>update-feature-planned-dates</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{html:'<a href="https://help.rallydev.com/apps/2.0rc2/doc/">App SDK 2.0rc2 Docs</a>'},launch:function(){app=this,this.rallyFunctions=Ext.create("RallyFunctions",{ctx:this.getContext(),keys:["iterations","releases"]}),this.rallyFunctions.readRallyItems().then({success:function(bundle){app.bundle=bundle;var filter=app._createReleaseFilter();Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["portfolioitem/feature"],autoLoad:!0,enableHierarchy:!0,filters:[filter]}).then({success:app._onStoreBuilt,scope:app})}})},_createReleaseFilter:function(){var today=new Date,filter,releases=_.filter(app.bundle.releases,function(release){return today>=Rally.util.DateTime.fromIsoString(release.raw.ReleaseStartDate)&&Rally.util.DateTime.fromIsoString(release.raw.ReleaseDate)>=today});return _.each(releases,function(r,i){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operator:"=",value:r.get("_ref")});filter=0==i?f:filter.or(f)}),filter},_onStoreBuilt:function(store){console.log("_onStoreBuilt"),app.earliestIndex=9,app.latestIndex=10,app.add({xtype:"rallytreegrid",store:store,context:app.getContext(),enableEditing:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,enableRanking:!1,columnCfgs:["Name","Owner","Project","Release","Iteration","PlannedStartDate","PlannedEndDate","LeafStoryCount",{header:"Planned / Unplanned Count",dataIndex:"Parent",width:50,hidden:!1,renderer:app.renderCustomColumn},{header:"% Planned",dataIndex:"Parent",width:50,hidden:!1,renderer:app.renderPercentPlanned},{header:"Earliest Planned",dataIndex:"Parent",width:75,hidden:!1,renderer:app.renderEarliestDate},{header:"Latest Planned",dataIndex:"Parent",width:75,hidden:!1,renderer:app.renderLatestDate}]})},calcEarliestAndLatest:function(planned){var startDates=_.sortBy(_.map(planned,function(story){var i=_.find(app.bundle.iterations,function(it){return it.get("_ref")==story.get("Iteration")._ref});return Rally.util.DateTime.fromIsoString(i.raw.StartDate)})),endDates=_.sortBy(_.map(planned,function(story){var i=_.find(app.bundle.iterations,function(it){return it.get("_ref")==story.get("Iteration")._ref});return Rally.util.DateTime.fromIsoString(i.raw.EndDate)}));return{earliest:_.first(startDates),latest:_.last(endDates)}},calcPercentPlanned:function(planned,rec){var lsc=rec.get("LeafStoryCount")||0,pp=lsc>0&&planned.length>0?100*(planned.length/lsc):0;return Math.round(pp)},renderUpdateButton:function(value,meta,rec){var val=rec.get("Button");if(!_.isUndefined(val))return val;var id=Ext.id();Ext.defer(function(){Ext.widget("button",{renderTo:id,text:"Update",width:75,handler:function(){console.log("Info",rec.get("Name"))}})},50);var val=Ext.String.format('<div id="{0}"></div>',id);return rec.set("Button",val),val},renderPercentPlanned:function(value,meta,rec){return _.isUndefined(rec.get("PercentPlanned"))?"...":rec.get("PercentPlanned")},renderEarliestDate:function(value,meta,r,a,colIndex,c){if(value=r.get("Earliest"),_.isUndefined(value))return"...";var diff=Rally.util.DateTime.getDifference(value,r.get("PlannedStartDate"),"day");return Math.abs(diff)>0&&(meta.style="background-color:LemonChiffon;"),value.toISOString().slice(0,10)},renderLatestDate:function(value,meta,r,a,colIndex,c){if(value=r.get("Latest"),_.isUndefined(value))return"...";var diff=Rally.util.DateTime.getDifference(value,r.get("PlannedEndDate"),"day");return Math.abs(diff)>0&&(meta.style="background-color:LemonChiffon;"),value.toISOString().slice(0,10)},renderCustomColumn:function(value,meta,r){if("portfolioitem/feature"==r.get("_type")){var up=r.get("Unplanned"),p=r.get("Planned");if(_.isUndefined(up)||_.isUndefined(p)){var itemId=Ext.id();return Ext.defer(app.readStories,500,app,[value,itemId,r]),"..."}return 0==p.length&&up.length>0&&(meta.style="background-color:tomato;"),p.length>0&&0==up.length&&(meta.style="background-color:LightGreen;"),""+p.length+" / "+(_.isUndefined(p)?0:up.length)}return"-"},unplannedStories:function(list){var filteredList=_.filter(list,function(rec){return"hierarchicalrequirement"==rec.get("_type")&&0==rec.get("Children").Count&&(_.isNull(rec.get("Iteration"))||_.isUndefined(rec.get("Iteration")))});return filteredList},plannedStories:function(list){var filteredList=_.filter(list,function(rec){return"hierarchicalrequirement"==rec.get("_type")&&0==rec.get("Children").Count&&!(_.isNull(rec.get("Iteration"))||_.isUndefined(rec.get("Iteration")))});return filteredList},readStories:function(value,itemId,rec){this.rallyFunctions.recurseObject(rec).then({success:function(list){var unplanned=app.unplannedStories(list),planned=app.plannedStories(list);rec.set("Unplanned",unplanned),rec.set("Planned",planned);var elDates=app.calcEarliestAndLatest(planned);rec.set("Earliest",elDates.earliest),rec.set("Latest",elDates.latest),rec.set("PercentPlanned",app.calcPercentPlanned(planned,rec))}})}});
                Ext.define("RallyFunctions",function(){var self;return{config:{ctx:{},filter:null,featureFilter:null,keys:[],fns:{}},constructor:function(config){return self=this,this.initConfig(config),self.fns.scheduleStates=self._readStates,self.fns.peValues=self._loadPreliminaryEstimateValues,self.fns.releases=self._loadReleases,self.fns.iterations=self._loadIterations,self.fns.projects=self._loadProjects,self.fns.projectReleases=self._loadProjectReleases,self.fns.piTypes=self._loadPortfolioItemTypes,this},readRallyItems:function(callback){var deferred=Ext.create("Deft.Deferred"),fns=[self._initBundle];return _.each(self.keys,function(key){_.contains(_.keys(self.fns),key)&&fns.push(self.fns[key])}),Deft.Chain.pipeline(fns,self).then({success:function(bundle){deferred.resolve(bundle)},failure:function(error){console.log("Error:",error)}}),deferred.promise},readProjectWorkItems:function(callback){console.log("readProjectWorkItems",self.featureFilter);var fns=[self.readStates,self.readProjects,self.readStories];null!==self.featureFilter&&(fns=[self.readStates,self.readProjects,self.readFeatures]),Deft.Chain.pipeline(fns,self).then({success:function(workItems){callback(null,workItems,self.projects,self.scheduleStates)},failure:function(error){console.log("Error:",error)}})},_initBundle:function(){console.log("_initBundle");var deferred=Ext.create("Deft.Deferred");return deferred.resolve({}),deferred.promise},_readStates:function(bundle){var that=this,deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){var scheduleStates=_.map(records,function(r){return r.get("StringValue")});deferred.resolve({scheduleStates:scheduleStates})}})}}),deferred.promise},_loadPreliminaryEstimateValues:function(bundle){var that=this;console.log("_loadPreliminaryEstimateValues");var deferred=Ext.create("Deft.Deferred");return that._loadAStoreWithAPromise("PreliminaryEstimate",!0,[]).then({success:function(records){bundle.preliminaryEstimateValues=records,deferred.resolve(bundle)}}),deferred.promise},_loadReleases:function(bundle){var that=this;console.log("_loadReleases");var deferred=Ext.create("Deft.Deferred");return that._loadAStoreWithAPromise("Release",!0,[],{projectScopeDown:!0},"ReleaseDate").then({success:function(records){bundle.releases=records,deferred.resolve(bundle)}}),deferred.promise},_loadIterations:function(bundle){var that=this;console.log("_loadIterations");var deferred=Ext.create("Deft.Deferred");return that._loadAStoreWithAPromise("Iteration",!0,[],{projectScopeDown:!0},"IterationEndDate").then({success:function(records){bundle.iterations=records,deferred.resolve(bundle)}}),deferred.promise},_loadProjectReleases:function(bundle){console.log("_loadProjectReleases");var that=this,deferred=Ext.create("Deft.Deferred");return that._loadProjects(bundle).then({success:function(bundle){Deft.Promise.map(bundle.projects,function(project){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("Release",!0,[{property:"ReleaseDate",operator:">",value:self.getLastYearDate()},{property:"ReleaseStartDate",operator:"<=",value:self.getToday()}],{project:project.get("_ref"),projectScopeDown:!0}).then({success:function(records){deferred.resolve(records)}}),deferred.promise}).then({success:function(projectReleases){var prs=_.map(bundle.projects,function(project,i){return{project:project,parent:self.ctx.getProject().ObjectID==project.get("ObjectID"),releases:self._groupReleases(projectReleases[i])}});prs=_.sortBy(prs,function(pr){return pr.project.get("Name")}),bundle.projectReleases=_.sortBy(prs,function(pr){return!pr.parent}),deferred.resolve(bundle)}})}}),deferred.promise},_groupReleases:function(releases){var groupedReleases=_.groupBy(releases,function(release){return release.get("Name")}),logicalReleases=_.map(_.keys(groupedReleases),function(key){var releases=groupedReleases[key];return{name:_.first(releases).get("Name"),releaseDate:_.first(releases).get("ReleaseDate"),releaseStartDate:_.first(releases).get("ReleaseStartDate"),releases:releases}});return _.sortBy(logicalReleases,function(r){return r.releaseDate})},_loadProjects:function(bundle){var that=this,deferred=Ext.create("Deft.Deferred"),fetch=["ObjectID","Name","_ref","Parent","State","Parent","Children"];return console.log("_loadProjects"),self._loadAStoreWithAPromise("Project",fetch,[{property:"ObjectID",operator:"=",value:self.ctx.getProject().ObjectID}]).then({scope:that,success:function(projects){0===_.first(projects).get("Children").Count?(bundle.projects=projects,deferred.resolve(bundle)):_.first(projects).getCollection("Children").load({fetch:fetch,callback:function(records,operation,success){bundle.projects=_.filter(records,function(r){return"Closed"!==r.get("State")}),bundle.projects.unshift(_.first(projects)),deferred.resolve(bundle)}})}}),deferred.promise},_loadPortfolioItemTypes:function(bundle){console.log("_loadPortfolioItemTypes");var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("TypeDefinition",!0,[{property:"Ordinal",operator:"!=",value:-1}]).then({success:function(records){bundle.piTypes=records,deferred.resolve(bundle)}}),deferred.promise},readProjects:function(states){var deferred=Ext.create("Deft.Deferred"),me=this;return self._loadAStoreWithAPromise("Project",["_ref","Parent","Children"],[{property:"ObjectID",operator:"=",value:self.ctx.getProject().ObjectID}]).then({scope:me,success:function(projects){0===_.first(projects).get("Children").Count?(self.projects=projects,deferred.resolve(self.projects)):_.first(projects).getCollection("Children").load({fetch:["ObjectID","Name","_ref","Parent","State"],callback:function(records,operation,success){self.projects=_.filter(records,function(r){return"Closed"!==r.get("State")}),self.projects.push(_.first(projects)),console.log("self.projects",self.projects,projects),deferred.resolve(self.projects)}})}}),deferred.promise},readStories:function(projects){console.log("readStories",projects,self.filter);var me=this,promises=_.map(projects,function(project){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("HierarchicalRequirement",["ObjectID","ScheduleState","PlanEstimate","Project"],[self.filter],{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0}).then({scope:me,success:function(stories){console.log("stories",stories),deferred.resolve(stories)}}),deferred.promise});return Deft.Promise.all(promises)},readFeatures:function(projects){var me=this,readFeatureType=function(){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("TypeDefinition",["TypePath"],[{property:"Ordinal",operator:"=",value:0}]).then({scope:me,success:function(types){deferred.resolve(_.first(types).get("TypePath"))}}),deferred.promise},readFeatures=function(type){var promises=_.map(projects,function(project){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise(type,["FormattedID","Name","ObjectID","LeafStoryCount","LeafStoryPlanEstimateTotal","PreliminaryEstimate","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","c_ValueMetricKPI","Rank","State"],[self.featureFilter],{project:project.get("_ref"),projectScopeUp:!1,projectScopeDown:!0},[{property:"DragAndDropRank",direction:"ASC"}]).then({scope:me,success:function(stories){deferred.resolve(stories)}}),deferred.promise});return Deft.Promise.all(promises)},deferred=Ext.create("Deft.Deferred");return Deft.Chain.pipeline([readFeatureType,readFeatures],self).then({success:function(results){deferred.resolve(results)}}),deferred.promise},readPreferenceValues:function(keys){var me=this,promises=_.map(keys,function(key){var deferred=Ext.create("Deft.Deferred");return self._loadAStoreWithAPromise("Preference",["Name","Value"],[{property:"Name",operator:"=",value:key}]).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){deferred.resolve("")}}),deferred.promise});return Deft.Promise.all(promises)},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise},getLastYearDate:function(){var date=new Date;return date.setFullYear(date.getFullYear()-1),Rally.util.DateTime.toIsoString(date,!1)},getToday:function(){var date=new Date;return Rally.util.DateTime.toIsoString(date,!1)},recurseObject:function(obj,callback){var deferred=Ext.create("Deft.Deferred"),list=[],stack=1,childItems=function(obj,collection,callback){var children=obj.get(collection);children&&children.Count>0&&(stack+=children.Count,obj.getCollection(collection).load({fetch:!0,callback:function(records,operation,success){callback(records)}}))},walk=function(root){list.push(root),stack-=1,_.each(["Children","UserStories","Tasks","Defects","TestCases"],function(collection){childItems(root,collection,function(records){_.each(records,function(record){walk(record)})})}),0==stack&&deferred.resolve(list)};return walk(obj),deferred.promise}}});

            Rally.launchApp('CustomApp', {
                name:"update-feature-planned-dates",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
